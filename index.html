<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>미미로또방</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Arial', sans-serif;
      background: radial-gradient(circle at top, #ffeaa7, #fab1a0, #d980fa);
      animation: bgPulse 5s infinite alternate;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-bottom: 80px;
      overflow-x: hidden;
      position: relative;
    }
    @keyframes bgPulse {
      0% { background-position: 0% 50%; filter: brightness(1); }
      100% { background-position: 100% 50%; filter: brightness(1.2); }
    }

    header {
      margin-top: 20px;
      animation: fadeIn 1s ease;
      z-index: 1;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    img {
      width: 180px;
      height: auto;
    }
    .buttons {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 30px;
      margin-bottom: 10px;
      z-index: 1;
    }
    .buttons button {
      padding: 10px 15px;
      border: none;
      color: white;
      font-weight: bold;
      border-radius: 10px;
      cursor: pointer;
      font-size: 16px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.2);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .buttons button:active {
      transform: scale(1.1);
      box-shadow: 0 0 20px #fff;
    }
    .regular { background-color: #d63031; }
    .analysis { background-color: #0984e3; }
    .ai { background-color: #00b894; }

    .ball-container {
      display: flex;
      justify-content: center;
      margin: 20px 0;
      gap: 10px;
      flex-wrap: wrap;
      z-index: 1;
    }
    .ball {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: white;
      font-size: 18px;
      animation: spinIn 1s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    @keyframes spinIn {
      0% { transform: rotate(0deg) scale(0); opacity: 0; }
      100% { transform: rotate(360deg) scale(1); opacity: 1; }
    }

    .select-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 90%;
      max-width: 480px;
      margin: 10px 0;
      z-index: 1;
      gap: 8px;
    }
    .select-actions button {
      padding: 6px 12px;
      font-size: 14px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background-color: #2d3436;
      color: white;
    }

    .history {
      width: 90%;
      max-width: 480px;
      z-index: 1;
    }
    .history-item {
      background: white;
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      animation: fadeIn 0.5s ease;
    }
    .history-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      margin-bottom: 5px;
      gap: 8px;
    }
    .history-balls {
      display: flex;
      align-items: center;
      gap: 5px;
      flex-wrap: wrap;
    }
    .history-balls .ball {
      width: 30px;
      height: 30px;
      font-size: 14px;
      animation: none;
    }
    .delete-btn {
      background: #ccc;
      border: none;
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 12px;
      cursor: pointer;
    }
    .checkbox { margin-right: 5px; }

    /* Flash Effect */
    .flash {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.6);
      z-index: 99;
      animation: flashBang 0.4s ease;
      pointer-events: none;
    }
    @keyframes flashBang {
      0% { opacity: 0; }
      50% { opacity: 1; }
      100% { opacity: 0; }
    }

    /* Lotto Ball Particle Background */
    .particles {
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      z-index: 0;
      pointer-events: none;
    }
    .particles .lotto {
      position: absolute;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      color: white;
      animation: fallRotate linear infinite;
    }
    @keyframes fallRotate {
      0% {
        transform: translateY(-50px) rotate(0deg) scale(0.5);
        opacity: 0.7;
      }
      100% {
        transform: translateY(110vh) rotate(360deg) scale(1);
        opacity: 0;
      }
    }

    /* 로그인 미니바 */
    .mini-login {
      position: fixed; right: 10px; top: 10px; z-index: 2;
      display: flex; gap: 6px; align-items: center; padding: 8px 10px;
      background: rgba(255,255,255,0.85); color: #111;
      border-radius: 12px; backdrop-filter: blur(6px);
    }
    .mini-login input {
      padding: 6px 8px; border-radius: 8px; border: 1px solid #bbb; width: 120px;
    }
    .mini-login button {
      padding: 6px 10px; border: none; border-radius: 8px;
      background: #2d3436; color: #fff; cursor: pointer;
    }
    .badge {
      background: #2d3436; color: #fff; padding: 4px 8px;
      border-radius: 999px; font-size: 12px;
    }
  </style>
</head>
<body>
  <!-- 배경 음악 -->
  <audio autoplay loop>
    <source src="https://raw.githubusercontent.com/pageno/Mimi/main/%EB%AF%B8%EB%AF%B8%EB%A1%9C%EB%98%90%EB%B0%A9.mp3" type="audio/mpeg">
  </audio>

  <!-- 배경 파티클 -->
  <div class="particles" id="particles"></div>

  <!-- 로고 -->
  <header>
    <img src="https://raw.githubusercontent.com/pageno/Mimi/main/mimilogo.png" alt="미미로또방 로고">
  </header>

  <!-- 버튼 -->
  <div class="buttons">
    <button class="regular" onclick="drawNumbers('일반', '#d63031')">일반 뽑기</button>
    <button class="analysis" onclick="drawNumbers('분석', '#0984e3')">분석 뽑기</button>
    <button class="ai" onclick="drawNumbers('AI', '#00b894')">AI 뽑기</button>
  </div>

  <!-- 공 출력 -->
  <div class="ball-container" id="balls"></div>

  <!-- 선택/삭제 -->
  <div class="select-actions">
    <label><input type="checkbox" id="selectAll" onchange="toggleAll(this)"> 전체 선택</label>
    <div style="display:flex; gap:8px;">
      <button onclick="deleteSelected()">선택 삭제</button>
      <button onclick="deleteAll()">전체 삭제</button>
    </div>
  </div>

  <!-- 히스토리 -->
  <div class="history" id="history"></div>

  <script>
    /* ----------------------- 기존 번호 뽑기/렌더 ----------------------- */
    let drawing = false;

    function drawNumbers(type, flashColor = "#fff") {
      if (drawing) return;
      drawing = true;

      const flash = document.createElement('div');
      flash.className = 'flash';
      flash.style.background = flashColor + 'AA';
      document.body.appendChild(flash);
      setTimeout(() => flash.remove(), 500);

      const numbers = new Set();
      while (numbers.size < 6) {
        numbers.add(Math.floor(Math.random() * 45) + 1);
      }
      const result = [...numbers].sort((a, b) => a - b);

      const container = document.getElementById('balls');
      container.innerHTML = '';

      result.forEach((num, i) => {
        setTimeout(() => {
          const ball = document.createElement('div');
          ball.className = 'ball';
          ball.textContent = num;
          ball.style.background = getColor(num);
          container.appendChild(ball);
          if (i === result.length - 1) {
            setTimeout(() => {
              saveHistory(result, type);  // ⬅ 저장 연결
              drawing = false;
            }, 500);
          }
        }, i * 400);
      });
    }

    function getColor(num) {
      if (num <= 10) return '#fbc531';
      if (num <= 20) return '#00a8ff';
      if (num <= 30) return '#e84118';
      if (num <= 40) return '#9c88ff';
      return '#4cd137';
    }

    function saveHistory(numbers, type) {
      const history = document.getElementById('history');
      const item = document.createElement('div');
      item.className = 'history-item';

      const now = new Date();
      const label = `${now.toLocaleDateString()} ${now.toLocaleTimeString()} (${type})`;

      const top = document.createElement('div');
      top.className = 'history-top';

      const left = document.createElement('div');
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.className = 'checkbox';
      left.appendChild(checkbox);
      left.appendChild(document.createTextNode(label));

      const delBtn = document.createElement('button');
      delBtn.className = 'delete-btn';
      delBtn.textContent = '삭제';
      delBtn.onclick = () => {
        // 화면 삭제 + 스토리지 동기화
        history.removeChild(item);
        syncStorageFromDOM();
      };

      top.appendChild(left);
      top.appendChild(delBtn);

      const balls = document.createElement('div');
      balls.className = 'history-balls';
      numbers.forEach(n => {
        const b = document.createElement('div');
        b.className = 'ball';
        b.textContent = n;
        b.style.background = getColor(n);
        balls.appendChild(b);
      });

      item.appendChild(top);
      item.appendChild(balls);
      history.insertBefore(item, history.firstChild);
    }

    function toggleAll(source) {
      document.querySelectorAll('.checkbox').forEach(cb => cb.checked = source.checked);
    }

    function deleteSelected() {
      document.querySelectorAll('.checkbox:checked').forEach(cb => {
        const item = cb.closest('.history-item');
        if (item) item.remove();
      });
      syncStorageFromDOM();
    }

    function deleteAll() {
      document.getElementById('history').innerHTML = '';
      syncStorageFromDOM();
    }

    function generateParticles() {
      const particleArea = document.getElementById('particles');
      for (let i = 0; i < 40; i++) {
        const lotto = document.createElement('div');
        lotto.className = 'lotto';

        const num = Math.floor(Math.random() * 45) + 1;
        lotto.textContent = num;
        lotto.style.background = getColor(num);
        lotto.style.left = Math.random() * 100 + 'vw';
        lotto.style.animationDuration = (Math.random() * 5 + 5) + 's';
        lotto.style.animationDelay = (Math.random() * 10) + 's';
        particleArea.appendChild(lotto);
      }
    }
  </script>

  <script>
    /* ----------------------- 로그인/자동로그인 + 유저별 저장 ----------------------- */
    const LS_CURRENT = "mimi_current_user";

    function getCurrentUser(){ return (localStorage.getItem(LS_CURRENT) || "").trim(); }
    function setCurrentUser(id){ localStorage.setItem(LS_CURRENT, (id||"").trim()); }

    function historyKey(){
      const u = getCurrentUser();
      return u ? `history_${u}` : "history_guest";
    }
    function loadHistoryList(){
      try { return JSON.parse(localStorage.getItem(historyKey()) || "[]"); }
      catch { return []; }
    }
    function saveHistoryList(list){
      localStorage.setItem(historyKey(), JSON.stringify(list));
    }

    // DOM → 스토리지로 동기화 (삭제/전체삭제 시 호출)
    function syncStorageFromDOM(){
      const container = document.getElementById('history');
      const items = Array.from(container.querySelectorAll('.history-item'));
      const list = items.map(it=>{
        const nums = Array.from(it.querySelectorAll('.history-balls .ball'))
          .map(b=>Number(b.textContent)).sort((a,b)=>a-b);
        const label = it.querySelector('.history-top')?.innerText || "";
        const type = (label.match(/\((.*?)\)/)||[])[1] || "일반";
        const tsMatch = label.match(/(\d{4}.\d{1,2}.\d{1,2}.*\d{1,2}:\d{2}:\d{2})/); // 지역포맷 다양해 대략 저장
        return { numbers: nums, type, ts: Date.now() };
      });
      saveHistoryList(list);
    }

    // 기존 saveHistory 호출마다 스토리지에도 즉시 기록되도록 패치
    (function patchSaveHistory(){
      if (window._patchedSave) return;
      window._patchedSave = true;
      const _orig = window.saveHistory;
      window.saveHistory = function(numbers, type){
        _orig(numbers, type);
        // append to storage (맨 앞에 추가)
        const list = loadHistoryList();
        list.unshift({ numbers, type, ts: Date.now() });
        saveHistoryList(list);
      };
    })();

    // 스토리지 → DOM 렌더 (로그인 전환/초기 로드시)
    function renderHistoryFromStorage(){
      const list = loadHistoryList();
      const container = document.getElementById('history');
      container.innerHTML = "";
      list.forEach(item=>{
        // UI 렌더(원본 saveHistory UI와 동일 형태)
        const div = document.createElement('div');
        div.className = 'history-item';

        const dt = new Date(item.ts);
        const label = `${dt.toLocaleDateString()} ${dt.toLocaleTimeString()} (${item.type})`;

        const top = document.createElement('div');
        top.className = 'history-top';

        const left = document.createElement('div');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'checkbox';
        left.appendChild(checkbox);
        left.appendChild(document.createTextNode(label));

        const delBtn = document.createElement('button');
        delBtn.className = 'delete-btn';
        delBtn.textContent = '삭제';
        delBtn.onclick = () => { div.remove(); syncStorageFromDOM(); };

        top.appendChild(left);
        top.appendChild(delBtn);

        const balls = document.createElement('div');
        balls.className = 'history-balls';
        (item.numbers||[]).forEach(n=>{
          const b = document.createElement('div');
          b.className = 'ball';
          b.textContent = n;
          b.style.background = getColor(n);
          balls.appendChild(b);
        });

        div.appendChild(top);
        div.appendChild(balls);
        container.appendChild(div);
      });
    }

    // 로그인 미니바
    function mountLoginBar(){
      const bar = document.createElement('div');
      bar.className = 'mini-login';
      document.body.appendChild(bar);

      function renderBar(){
        const u = getCurrentUser();
        bar.innerHTML = "";
        if (u){
          const badge = document.createElement('span');
          badge.className = 'badge';
          badge.textContent = `ID: ${u}`;
          const btnLogout = document.createElement('button');
          btnLogout.textContent = '로그아웃';
          btnLogout.onclick = ()=>{
            setCurrentUser("");
            renderBar();
            renderHistoryFromStorage(); // 게스트 히스토리로 전환
          };
          bar.appendChild(badge);
          bar.appendChild(btnLogout);
        } else {
          const input = document.createElement('input');
          input.placeholder = 'ID 입력';
          const btnLogin = document.createElement('button');
          btnLogin.textContent = '로그인';
          btnLogin.onclick = ()=>{
            const id = (input.value||"").trim();
            if (!id) return alert('ID를 입력하세요');
            setCurrentUser(id);
            renderBar();
            renderHistoryFromStorage(); // 해당 ID 히스토리 로드
          };
          bar.appendChild(input);
          bar.appendChild(btnLogin);
        }
      }
      renderBar();
    }

    // 부팅
    window.addEventListener('load', ()=>{
      generateParticles();
      setInterval(generateParticles, 8000);
      mountLoginBar();          // 로그인 UI
      renderHistoryFromStorage(); // 자동 로그인된 사용자 히스토리 표시
    });
  </script>
</body>
</html>
